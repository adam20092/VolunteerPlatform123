name: Deploy to SmarterASP

on:
  push:
    branches: [ main, master, sigma ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: smarterasp-prod
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT: "VolunteerPlatform/volunteerplatform/volunteerplatform.csproj"
      PUBLISH_DIR: "./publish_output"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore "${{ env.PROJECT }}"

      - name: Build (Release)
        run: dotnet build "${{ env.PROJECT }}" -c Release --no-restore

      # Ако имаш тестове, махни коментара и сложи път към тест проект/solution
      # - name: Test
      #   run: dotnet test -c Release --no-build

      # ✅ Ако имаш index.html в repo root и искаш да се вижда:
      # копира го в wwwroot, за да бъде включен в publish output-а.
      - name: Put index.html into wwwroot
        run: |
          mkdir -p "VolunteerPlatform/volunteerplatform/wwwroot"
          cp -f "index.html" "VolunteerPlatform/volunteerplatform/wwwroot/index.html"

      - name: Publish
        run: dotnet publish "${{ env.PROJECT }}" -c Release --no-build -o "${{ env.PUBLISH_DIR }}"

      - name: Deploy via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ${{ env.PUBLISH_DIR }}/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.github/**
            **/appsettings.Development.json
            **/*.pdb
